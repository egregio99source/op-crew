<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Piece Crew Builder - Dual Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --paper-color: #f4e4bc; 
            --gold: #ffd700;
            --red: #aa0000;
            --dark-overlay: rgba(44, 36, 27, 0.92);
            --brown-btn: #5e4b35;
            
            /* Colori Rarit√† */
            --rarity-5: #ff4500; /* Rosso Arancio Leggendario */
            --rarity-4: #9932cc; /* Viola Epico */
            --rarity-3: #1e90ff; /* Blu Raro */
            --rarity-2: #32cd32; /* Verde Non Comune */
            --rarity-1: #a9a9a9; /* Grigio Comune */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
            margin: 0;
            padding: 0;
            text-align: center;
            background-image: url("img/sfondoop.png"); 
            background-size: cover;       
            background-position: center;  
            background-attachment: fixed; 
            background-repeat: no-repeat;
        }

        h1 {
            font-family: 'Pirata One', cursive;
            color: var(--gold);
            font-size: 4rem;
            margin-top: 20px;
            margin-bottom: 10px;
            text-shadow: 4px 4px 0px #000, 0 0 20px rgba(255, 165, 0, 0.8); 
            letter-spacing: 3px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0,0,0, 0.3);
            min-height: 100vh;
            backdrop-filter: blur(3px);
            padding-bottom: 50px;
        }

        /* --- SELEZIONE MODALIT√Ä --- */
        .mode-selector {
            padding: 20px 0 10px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(0,0,0,0.6);
        }

        .mode-btn {
            font-family: 'Pirata One', cursive;
            font-size: 1.3rem;
            padding: 8px 20px;
            border: 2px solid #555;
            background: rgba(0,0,0,0.5);
            color: #aaa;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .mode-btn:hover {
            border-color: var(--gold);
            color: #fff;
        }

        .mode-btn.active {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
            box-shadow: 0 0 15px var(--gold);
        }

        /* --- BARRA LIMITI (BUDGET) --- */
        .limits-bar {
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid var(--gold);
            border-bottom: 2px solid var(--gold);
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            transition: all 0.3s;
        }
        
        /* Stile speciale per la barra quando in sandbox */
        .limits-bar.sandbox-mode {
            border-color: #32cd32;
        }

        .limit-item {
            font-family: 'Pirata One', cursive;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #555;
        }

        .limit-item span { font-weight: bold; margin-left: 5px; }
        .limit-full { opacity: 0.5; text-decoration: line-through; }
        .limit-ok { color: var(--gold); border-color: var(--gold); }
        .limit-over { color: var(--red); border-color: var(--red); font-weight: bold;}

        /* --- BARRA AGGIUNTA RUOLI --- */
        .options-bar {
            background: var(--dark-overlay);
            padding: 15px;
            margin: 20px auto;
            max-width: 90%;
            border: 1px solid var(--gold);
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .option-btn {
            background: var(--paper-color);
            color: #2c241b;
            font-family: 'Pirata One', cursive;
            font-size: 1.1rem;
            border: 2px solid var(--brown-btn);
            padding: 5px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .option-btn:hover { background: var(--gold); transform: scale(1.05); }
        .option-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #ccc; transform: none; }

        .custom-role-container {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid var(--gold);
        }
        .custom-input {
            padding: 5px;
            border-radius: 4px;
            border: 2px solid var(--brown-btn);
            font-family: 'Pirata One', cursive;
            font-size: 1rem;
            width: 120px;
        }

        /* --- SEZIONE EQUIPAGGIO --- */
        .crew-section {
            background: rgba(0, 0, 0, 0.5);
            padding: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            min-height: 280px;
            margin-bottom: 30px;
        }

        .role-card {
            width: 130px;
            height: 220px;
            background-color: var(--paper-color);
            background-image: url("https://www.transparenttextures.com/patterns/old-paper.png");
            border: 3px solid #5e4b35;
            border-radius: 4px;
            box-shadow: 8px 8px 20px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            position: relative;
            transition: transform 0.2s;
            cursor: pointer;
            color: #333;
        }
        .role-card:hover { transform: translateY(-5px); }
        .role-card.active {
            border: 3px solid var(--red);
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--red);
            z-index: 10;
        }

        .role-name {
            font-family: 'Pirata One', cursive;
            font-size: 1.2rem;
            text-transform: uppercase;
            border-bottom: 2px solid #5e4b35;
            width: 100%;
            margin-bottom: 5px;
            color: #2c241b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-slot {
            width: 90px;
            height: 90px;
            background: #dcd0b0;
            border: 2px dashed #8b7d6b;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 50%;
            margin-bottom: 5px;
            position: relative;
        }
        .image-slot img { width: 100%; height: 100%; object-fit: cover; }

        .card-stars {
            font-size: 10px;
            margin-bottom: 2px;
            letter-spacing: -1px;
        }

        .bounty-text {
            font-family: 'Pirata One', cursive;
            font-size: 1rem;
            margin-top: auto;
            color: #666;
            line-height: 1.1;
        }

        .remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--red);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            display: block;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        /* --- TAVERNA --- */
        .tavern-section {
            padding: 20px;
            background: var(--dark-overlay);
            border-radius: 20px 20px 0 0;
            margin: 0 20px;
            border: 2px solid var(--gold);
            border-bottom: none;
        }

        .search-bar {
            padding: 10px;
            width: 250px;
            border-radius: 20px;
            border: 2px solid var(--gold);
            margin-bottom: 20px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            font-family: 'Pirata One', cursive;
            text-align: center;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .char-select {
            background: rgba(244, 228, 188, 0.1);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .char-select:hover {
            transform: scale(1.1);
            background: rgba(244, 228, 188, 0.9);
            color: #000;
            z-index: 5;
        }
        
        .char-select.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        .char-select.disabled:hover { transform: none; background: transparent; color: #fff; }

        .char-select img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #555;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .rarity-5 img { border-color: var(--rarity-5); box-shadow: 0 0 10px var(--rarity-5); }
        .rarity-4 img { border-color: var(--rarity-4); }
        .rarity-3 img { border-color: var(--rarity-3); }
        .rarity-2 img { border-color: var(--rarity-2); }
        .rarity-1 img { border-color: var(--rarity-1); }

        .char-name {
            font-weight: bold;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
            text-shadow: 1px 1px 2px #000;
        }
        .char-select:hover .char-name { text-shadow: none; }
        
        .char-stars {
            display: block;
            font-size: 10px;
            margin-top: 2px;
            color: var(--gold);
        }

        .header-subtitle {
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.9rem;
            color: #ddd;
            margin-top: -10px;
            margin-bottom: 30px;
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px #000;
            opacity: 0.8;
        }

        .site-footer {
            margin-top: 50px;
            padding: 30px 20px;
            background: rgba(20, 15, 10, 0.95);
            border-top: 2px solid var(--brown-btn);
            color: #aaa;
            font-size: 0.8rem;
            line-height: 1.5;
            text-align: center;
        }

        .disclaimer-box {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }

        .disclaimer-lang {
            flex: 1;
            min-width: 300px;
        }

        .disclaimer-lang h4 {
            color: var(--gold);
            font-family: 'Pirata One', cursive;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .copyright-line {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #444;
            font-size: 0.75rem;
            color: #666;
            width: 100%;
        }

        .save-btn {
            background: #2e8b57;
            color: #fff;
            font-family: 'Pirata One', cursive;
            font-size: 1.5rem;
            padding: 10px 25px;
            border: 2px solid #fff;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .save-btn:hover {
            background: #3cb371;
            transform: scale(1.1);
            box-shadow: 0 0 25px #3cb371;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div class="main-container">
        
        <div class="mode-selector">
            <button class="mode-btn active" id="btn-mode-standard" onclick="setMode('standard')">‚ò†Ô∏è Challenge (Limits)</button>
            <button class="mode-btn" id="btn-mode-sandbox" onclick="setMode('sandbox')">üèùÔ∏è Sandbox (No Limits)</button>
        </div>

        <div class="limits-bar" id="limits-bar">
            <div class="limit-item" id="limit-5" style="color: var(--rarity-5)">
                Legendaries: <span id="count-5">0</span><span id="max-5">/1</span>
            </div>
            <div class="limit-item" id="limit-4" style="color: var(--rarity-4)">
                Epics: <span id="count-4">0</span><span id="max-4">/2</span>
            </div>
            <div class="limit-item" id="limit-3" style="color: var(--rarity-3)">
                Rares: <span id="count-3">0</span><span id="max-3">/3</span>
            </div>
            <div class="limit-item" id="limit-2" style="color: var(--rarity-2)">
                Uncommons: <span id="count-2">0</span><span id="max-2">/4</span>
            </div>
            <div class="limit-item" id="limit-1" style="color: #fff">
                Commons: <span id="count-1">0</span>/‚àû
            </div>
        </div>


        <h1>üè¥‚Äç‚ò†Ô∏è Create your crew üè¥‚Äç‚ò†Ô∏è</h1>
        <p class="header-subtitle">
            PROJECT FOR FUN ONLY - NO MONETIZATION - FAN ART
        </p>
        
        <div class="options-bar" id="options-container">
            <div class="custom-role-container">
                <input type="text" id="customRoleInput" class="custom-input" placeholder="Add some Extra..." maxlength="12">
                <button class="option-btn" onclick="addCustomRole()">+ Add</button>
            </div>
        </div>

        <div class="crew-section" id="crew-container">
            </div>
        
        <div style="margin: 20px auto; display: flex; justify-content: center; gap: 15px;">
            <button class="save-btn" onclick="downloadCrew()">
                üì∏ WANTED POSTER (Save Image)
            </button>
        </div>

        <div class="tavern-section">
            <h2>üç∫ La Taverna üç∫</h2>
            <p style="color: #ccc; font-size: 0.9rem;" id="tavern-rules">
                </p>
            <input type="text" id="search" class="search-bar" placeholder="Cerca pirata..." onkeyup="filterCharacters()">
            
            <div class="character-grid" id="char-grid">
                </div>
        </div>
    </div>
    <footer class="site-footer">
            <div class="disclaimer-box">
                
                <div class="disclaimer-lang">
                    <h4>Avvertenza Legale</h4>
                    <p>
                        Questo sito √® un progetto <strong>fan-made senza scopo di lucro</strong>. 
                        Non √® in alcun modo affiliato, supportato o sponsorizzato da 
                        <strong>Eiichiro Oda</strong>, <strong>Shueisha</strong>, <strong>Toei Animation</strong> 
                        o qualsiasi altro detentore ufficiale dei diritti di <em>One Piece</em>.
                    </p>
                    <p>
                        Tutte le immagini e i nomi dei personaggi utilizzati sono marchi registrati dei rispettivi proprietari. 
                        L'uso di tali materiali in questo contesto rientra nella dottrina del <strong>"Fair Use"</strong> 
                        (uso leale) a scopo di parodia, intrattenimento e apprezzamento dei fan, senza alcuna intenzione di violare il copyright.
                        Nessun guadagno economico viene generato da questo sito.
                        Per problemi contattare contact 09_gravoso_tapiro@icloud.com
                    </p>
                </div>

                <div class="disclaimer-lang">
                    <h4>Legal Disclaimer</h4>
                    <p>
                        This website is a <strong>non-profit fan-made project</strong>. 
                        It is not affiliated with, endorsed, sponsored, or specifically approved by 
                        <strong>Eiichiro Oda</strong>, <strong>Shueisha</strong>, <strong>Toei Animation</strong>, 
                        or any other official rights holders of <em>One Piece</em>.
                    </p>
                    <p>
                        All character images and names used herein are trademarks of their respective owners. 
                        The use of such materials falls under the <strong>"Fair Use"</strong> doctrine 
                        for purposes of parody, entertainment, and fan appreciation, with no intention of copyright infringement.
                        No financial gain is generated from this website.
                        Please for any kind of problem contact 09_gravoso_tapiro@icloud.com
                    </p>
                </div>

                <div class="copyright-line">
                    One Piece ¬© Eiichiro Oda / Shueisha, Toei Animation. All rights reserved to the original owners. Contact: 09_gravoso_tapiro@icloud.com
                </div>
            </div>
        </footer>

    </div>

    <script>
        // --- 1. CONFIGURAZIONE RARIT√Ä E LIMITI ---
        
        // Modalit√† Standard (Aggiornata secondo richiesta)
        const RARITY_LIMITS = {
            5: 1, // Leggendari (default)
            4: 1, // Epici (Aumentato)
            3: 2, // Rari (Aumentato)
            2: 3, // Non Comuni (Aumentato)
            1: 999 // Comuni (infiniti)
        };

        let isSandboxMode = false;
        let currentCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };

        // --- 2. DATABASE PERSONAGGI ---
        const characters = [
            // ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê LEGGENDARI (Max 1)
            { name: "Gol D. Roger", rarity: 5, img: "img/Gol_D._Roger_primo_piano.webp" },
            { name: "Whitebeard", rarity: 5, img: "img/Edward_Newgate_primo_piano.webp" },
            { name: "Shanks", rarity: 5, img: "img/Shanks_primo_piano.webp" },
            { name: "Kaido", rarity: 5, img: "img/Kaido_primo_piano.webp" },
            { name: "Big Mom", rarity: 5, img: "img/Charlotte_LinLin_primo_piano.webp" },
            { name: "Blackbeard", rarity: 5, img: "img/Marshall_D._Teach_primo_piano.webp" },
            { name: "Luffy", rarity: 5, img: "img/Monkey_D._Rufy_primo_piano.webp" },
            { name: "Garp", rarity: 5, img: "img/Monkey_D._Garp_primo_piano.webp" },
            { name: "Sengoku", rarity: 5, img: "img/Sengoku_dopo_primo_piano.webp" },
            { name: "Dragon", rarity: 5, img: "img/Dragon_primo_piano.webp" },
            { name: "Jaygarcia Saturn", rarity: 5, img: "img/Jaygarcia_Saturn_primo_piano.webp" },
            { name: "Ethanbaron V. Nusjuro", rarity: 5, img: "img/Ethanbaron_V._Nusjuro_primo_piano.webp" },
            { name: "Topman Warcury", rarity: 5, img: "img/Topman_Warcury_primo_piano.webp" },
            { name: "Marcus Mars", rarity: 5, img: "img/Marcus_Mars_primo_piano.webp" },
            { name: "Shepherd Ju Peter", rarity: 5, img: "img/Shepherd_Ju_Peter_primo_piano.webp" },
            { name: "Figarland Garling", rarity: 5, img: "img/Figarland_Garling_primo_piano.webp" },
            { name: "Kong", rarity: 5, img: "img/Kong_primo_piano.webp" },

            // ‚≠ê‚≠ê‚≠ê‚≠ê EPICI (Max 2)
            { name: "Akainu", rarity: 4, img: "img/Sakazuki_primo_piano.webp" },
            { name: "Aokiji", rarity: 4, img: "img/Kuzan_dopo_primo_piano.webp" },
            { name: "Kizaru", rarity: 4, img: "img/Borsalino_primo_piano.webp" },
            { name: "Fujitora", rarity: 4, img: "img/Issho_primo_piano.webp" },
            { name: "Aramaki (Greenbull)", rarity: 4, img: "img/Aramaki_primo_piano.webp" },
            { name: "Benn Beckman", rarity: 4, img: "img/Benn_Beckman_primo_piano.webp" },
            { name: "Oden", rarity: 4, img: "img/Kozuki_Oden_primo_piano.webp" },
            { name: "Zoro", rarity: 4, img: "img/Zoro_primo_piano.webp" },
            { name: "Sanji", rarity: 4, img: "img/Sanji_primo_piano.webp" },
            { name: "Law", rarity: 4, img: "img/Trafalgar_D._Water_Law_primo_piano.webp" },
            { name: "Kidd", rarity: 4, img: "img/Kidd_primo_piano.webp" },
            { name: "Sabo", rarity: 4, img: "img/Sabo_adulto_primo_piano.webp" },
            { name: "Marco", rarity: 4, img: "img/Marco_primo_piano.webp" },
            { name: "Katakuri", rarity: 4, img: "img/Charlotte_Katakuri_primo_piano.webp" },
            { name: "King (Arbel)", rarity: 4, img: "img/Arbel_primo_piano.webp" },
            { name: "Shiryu", rarity: 4, img: "img/Shiryu_primo_piano.webp" },
            { name: "Boa Hancock", rarity: 4, img: "img/Boa_Hancock_primo_piano.webp" },
            { name: "Kuma", rarity: 4, img: "img/Orso_Bartholomew_primo_piano.webp" }, 
            { name: "Doflamingo", rarity: 4, img: "img/Don_Quijote_Do_Flamingo_primo_piano.webp" },
            { name: "Crocodile", rarity: 4, img: "img/Crocodile_primo_piano.webp" },
            { name: "Jinbe", rarity: 4, img: "img/Jinbe_primo_piano.webp" },
            { name: "Mihawk", rarity: 4, img: "img/Drakul_Mihawk_primo_piano.webp" },
            { name: "Scien", rarity: 4, img: "img/Scien_primo_piano.webp" },
            { name: "Shirahoshi", rarity: 4, img: "img/Shirahoshi_primo_piano.webp" },

            // ‚≠ê‚≠ê‚≠ê RARI (Max 3)
            { name: "Ace", rarity: 3, img: "img/Portuguese_D._Ace_primo_piano.webp" },
            { name: "Rob Lucci", rarity: 3, img: "img/Rob_Lucci_primo_piano.webp" },
            { name: "Magellan", rarity: 3, img: "img/Magellan_primo_piano.webp" }, 
            { name: "Enel", rarity: 3, img: "img/Ener_primo_piano.webp" }, 
            { name: "Ivankov", rarity: 3, img: "img/Emporio_Ivankov_primo_piano.webp" },
            { name: "Koby", rarity: 3, img: "img/Kobi_dopo_primo_piano.webp" },
            { name: "Momonga", rarity: 3, img: "img/Momonga_primo_piano.webp" },
            { name: "Jack", rarity: 3, img: "img/Jack_primo_piano.webp" },
            { name: "Cracker", rarity: 3, img: "img/Charlotte_Cracker_primo_piano.webp" },
            { name: "Smoothie", rarity: 3, img: "img/Charlotte_Smoothie_primo_piano.webp" },
            { name: "Perospero", rarity: 3, img: "img/Charlotte_Perospero_primo_piano.webp" },
            { name: "Jaws", rarity: 3, img: "img/Jaws_primo_piano.webp" },
            { name: "Vista", rarity: 2, img: "img/Vista_primo_piano.webp" }, 
            { name: "Yasopp", rarity: 3, img: "img/Yasop_primo_piano.webp" },
            { name: "Lucky Roux", rarity: 3, img: "img/Lucky_Lou_primo_piano.webp" },
            { name: "Burgess", rarity: 3, img: "img/Jesus_Burgess_primo_piano.webp" },
            { name: "Van Augur", rarity: 3, img: "img/Van_Ooger_primo_piano.webp" },
            { name: "Laffitte", rarity: 3, img: "img/Lafitte_primo_piano.webp" },
            { name: "Doc Q", rarity: 3, img: "img/Doc_Q_primo_piano.webp" },
            { name: "Pizarro", rarity: 3, img: "img/Avalo_Pizarro_primo_piano.webp" },
            { name: "Katarina Devon", rarity: 3, img: "img/Katarina_Devon_primo_piano.webp" },
            { name: "Vasco Shot", rarity: 3, img: "img/Vasco_Shot_primo_piano.webp" },
            { name: "San Juan Wolf", rarity: 3, img: "img/San_Juan_Wolf_primo_piano.webp" },
            { name: "Killer", rarity: 3, img: "img/Killer_primo_piano.webp" },
            { name: "X Drake", rarity: 3, img: "img/X_Drake_primo_piano.webp" },
            { name: "Hawkins", rarity: 3, img: "img/Basil_Hawkins_primo_piano.webp" },
            { name: "Apoo", rarity: 3, img: "img/Apoo_primo_piano.webp" },
            { name: "Bege", rarity: 2, img: "img/Capone_Bege_primo_piano.webp" },
            { name: "Bonney", rarity: 3, img: "img/Jewelry_Bonney_primo_piano.webp" }, 
            { name: "Urouge", rarity: 3, img: "img/Urouge_primo_piano.webp" }, 
            { name: "Ashura Doji", rarity: 3, img: "img/Ashura_Doji_primo_piano.webp" },
            { name: "Denjiro", rarity: 3, img: "img/Denjiro_primo_piano.webp" },
            { name: "Kawamatsu", rarity: 3, img: "img/Kawamatsu_primo_piano.webp" },
            { name: "Kin'emon", rarity: 3, img: "img/Kinemon_primo_piano.webp" },
            { name: "Bartolomeo", rarity: 3, img: "img/Bartolomeo_primo_piano.webp" },
            { name: "Cavendish", rarity: 3, img: "img/Cavendish_primo_piano.webp" },
            { name: "Don Chinjao", rarity: 3, img: "img/Chinjao_primo_piano.webp" },
            { name: "Belo Betty", rarity: 3, img: "img/Belo_Betty_primo_piano.webp" },
            { name: "Karasu", rarity: 3, img: "img/Karasu_primo_piano.webp" },
            { name: "Morley", rarity: 3, img: "img/Morley_primo_piano.webp" },
            { name: "Lindbergh", rarity: 3, img: "img/Lindbergh_primo_piano.webp" },
            { name: "Judge", rarity: 3, img: "img/Vinsmoke_Judge_primo_piano.webp" },
            { name: "Ichiji", rarity: 3, img: "img/Vinsmoke_Ichiji_primo_piano.webp" },
            { name: "Niji", rarity: 3, img: "img/Vinsmoke_Niji_primo_piano.webp" },
            { name: "Reiju", rarity: 3, img: "img/Vinsmoke_Reiju_primo_piano.webp" },
            { name: "Yonji", rarity: 3, img: "img/Vinsmoke_Yonji_primo_piano.webp" },
            { name: "Fisher Tiger", rarity: 3, img: "img/Fisher_Tiger_primo_piano.webp" },
            { name: "Brook", rarity: 3, img: "img/Brook_primo_piano.webp" },
            { name: "Robin", rarity: 3, img: "img/Robin_primo_piano.webp" },
            { name: "Nami", rarity: 3, img: "img/Nami_primo_piano.webp" },
            { name: "Moria", rarity: 3, img: "img/Moria_primo_piano.webp" },

            // ‚≠ê‚≠ê NON COMUNI (Max 4)
            { name: "Franky", rarity: 2, img: "img/Franky_dopo_primo_piano.webp" }, 
            { name: "Chopper", rarity: 2, img: "img/Chopper_primo_piano.webp" }, 
            { name: "Usopp", rarity: 3, img: "img/Usop_primo_piano.webp" }, 
            { name: "Carrot", rarity: 2, img: "img/Carrot_primo_piano.webp" },
            { name: "Bepo", rarity: 2, img: "img/Bepo_primo_piano.webp" },
            { name: "Jean Bart", rarity: 2, img: "img/Jean_Bart_primo_piano.webp" },
            { name: "Hogback", rarity: 2, img: "img/Hogback_primo_piano.webp" },
            { name: "Perona", rarity: 2, img: "img/Perona_primo_piano.webp" },
            { name: "Caesar", rarity: 2, img: "img/Caesar_Marina_primo_piano.webp" }, 
            { name: "Vergo", rarity: 2, img: "img/Vergo_primo_piano.webp" },
            { name: "Monet", rarity: 2, img: "img/Monet_primo_piano.webp" }, 
            { name: "Pica", rarity: 2, img: "img/Pica_primo_piano.webp" },
            { name: "Diamante", rarity: 2, img: "img/Diamante_primo_piano.webp" },
            { name: "Trebol", rarity: 2, img: "img/Trebol_primo_piano.webp" },
            { name: "Corazon", rarity: 2, img: "img/Don_Quijote_Rosinante_primo_piano.webp" },
            { name: "Senor Pink", rarity: 2, img: "img/Senor_Pink_primo_piano.webp" },
            { name: "Bellamy", rarity: 2, img: "img/Bellamy_dopo_primo_piano.webp" },
            { name: "Kaku", rarity: 2, img: "img/Kaku_primo_piano.webp" },
            { name: "Blueno", rarity: 2, img: "img/Blueno_primo_piano.webp" },
            { name: "Kalifa", rarity: 2, img: "img/Califa_primo_piano.webp" },
            { name: "Spandam", rarity: 2, img: "img/Spandam_primo_piano.webp" },
            { name: "Ohm", rarity: 2, img: "img/Ohm_primo_piano.webp" },
            { name: "Shura", rarity: 2, img: "img/Shura_primo_piano.webp" },
            { name: "Satori", rarity: 2, img: "img/Satori_primo_piano.webp" },
            { name: "Gedatsu", rarity: 2, img: "img/Gedatsu_primo_piano.webp" },
            { name: "Smoker", rarity: 2, img: "img/Smoker_dopo_primo_piano.webp" }, 
            { name: "Tashigi", rarity: 2, img: "img/Tashigi_dopo_primo_piano.webp" },
            { name: "Hina", rarity: 2, img: "img/Hina_primo_piano.webp" },
            { name: "Tsuru", rarity: 2, img: "img/Tsuru_primo_piano.webp" },
            { name: "Hajrudin", rarity: 2, img: "img/Hajrudin_primo_piano.webp" },
            { name: "Leo", rarity: 2, img: "img/Leo_primo_piano.webp" },
            { name: "Black Maria", rarity: 2, img: "img/Black_Maria_primo_piano.webp" },
            { name: "Kanjuro", rarity: 2, img: "img/Kurozumi_Kanjuro_primo_piano.webp" },
            { name: "Sandersonia", rarity: 2, img: "img/Boa_Sandersonia_primo_piano.webp" },
            { name: "Hancock (Sorella)", rarity: 2, img: "img/Boa_Marigold_primo_piano.webp" },
            { name: "Aladin", rarity: 2, img: "img/Aladin_dopo_primo_piano.webp" },
            { name: "Praline", rarity: 2, img: "img/Charlotte_Praline_primo_piano.webp" },
            { name: "Pell", rarity: 2, img: "img/Pell_primo_piano.webp" },
            { name: "Wadatsumi", rarity: 2, img: "img/Wadatsumi_primo_piano.webp" },
            { name: "Rockstar", rarity: 2, img: "img/Rockstar_primo_piano.webp" },
            { name: "Weeble", rarity: 2, img: "img/Edward_Weeble_primo_piano.webp" },
            { name: "Hannyabal", rarity: 2, img: "img/Hannyabal_primo_piano.webp" }, 
            { name: "Nekomamushi", rarity: 2, img: "img/Gatto-vipera_primo_piano.webp" }, 
            { name: "Inuarashi", rarity: 2, img: "img/Cane-tempesta_primo_piano.webp" }, 

            // ‚≠ê COMUNI (Infiniti)
            { name: "Buggy", rarity: 1, img: "img/Bagy_primo_piano.webp" },
            { name: "Alvida", rarity: 1, img: "img/Albida_primo_piano.webp" },
            { name: "Mr. 3 (Galdino)", rarity: 1, img: "img/Galdino_primo_piano.webp" },
            { name: "Mr. 2 (Bentham)", rarity: 1, img: "img/Bentham_primo_piano.webp" },
            { name: "Mr. 1 (Daz Bonez)", rarity: 1, img: "img/Das_Bornes_primo_piano.webp" },
            { name: "Arlong", rarity: 1, img: "img/Arlong_del_Sole.webp" },
            { name: "Hatchan", rarity: 1, img: "img/Hacchan_del_Sole.webp" },
            { name: "Kuro", rarity: 1, img: "img/Kuro_primo_piano.webp" }, 
            { name: "Krieg", rarity: 1, img: "img/Don_Krieg_primo_piano.webp" }, 
            { name: "Gin", rarity: 1, img: "img/Gin_primo_piano.webp" }, 
            { name: "Morgan", rarity: 1, img: "img/Morgan_primo_piano.webp" },
            { name: "Helmeppo", rarity: 1, img: "img/Hermeppo_primo_piano.webp" },
            { name: "Vivi (Bibi)", rarity: 1, img: "img/Bibi_primo_piano.webp" },
            { name: "Karoo", rarity: 1, img: "img/Carue_primo_piano.webp" },
            { name: "Igaram", rarity: 1, img: "img/Igaram_primo_piano.webp" },
            { name: "Wapol", rarity: 1, img: "img/Wapol_primo_piano.webp" },
            { name: "Foxy", rarity: 1, img: "img/Foxy_primo_piano.webp" },
            { name: "Hody Jones", rarity: 1, img: "img/Hody_Jones_primo_piano.webp" },
            { name: "Ginny", rarity: 1, img: "img/Ginny_primo_piano.webp" },
            { name: "Rebecca", rarity: 1, img: "img/Rebecca_primo_piano.webp" },
            { name: "Kyros", rarity: 1, img: "img/Kyros_primo_piano.webp" },
            { name: "Viola", rarity: 1, img: "img/Viola_primo_piano.webp" },
        ];

        // --- 3. GESTIONE STATO ---
        const availableOptionalRoles = [
            "Sniper", "Cook", "Doctor",
            "Archaeologist", "Carpenter", "Musician", "Helmsman"
        ];

        let crewState = [
            { id: 1, role: "Captain", char: null, isMandatory: true },
            { id: 2, role: "First Mate", char: null, isMandatory: true },
            { id: 3, role: "Navigator", char: null, isMandatory: true }
        ];


        let selectedSlotId = null;

        // --- LOGICA ---

        function init() {
            renderOptionsBar();
            renderCrew();
            setMode('standard'); // Default
        }

        // --- CAMBIO MODALIT√Ä ---
        function setMode(mode) {
            const btnStandard = document.getElementById('btn-mode-standard');
            const btnSandbox = document.getElementById('btn-mode-sandbox');
            const bar = document.getElementById('limits-bar');
            const ruleText = document.getElementById('tavern-rules');

            if (mode === 'sandbox') {
                isSandboxMode = true;
                btnSandbox.classList.add('active');
                btnStandard.classList.remove('active');
                bar.classList.add('sandbox-mode');
                ruleText.innerText = "Mod Sandbox Activated: No limits!";
            } else {
                isSandboxMode = false;
                btnStandard.classList.add('active');
                btnSandbox.classList.remove('active');
                bar.classList.remove('sandbox-mode');
                ruleText.innerText = `Regole: ${RARITY_LIMITS[5]} Legendary | ${RARITY_LIMITS[4]} Epic | ${RARITY_LIMITS[3]} Rare | ${RARITY_LIMITS[2]} Uncommon | ‚àû Common`;
            }

            updateLimitsUI();
        }

        // --- Aggiorna la barra dei contatori ---
        function updateLimitsUI() {
            // Conta quanti ne abbiamo selezionati al momento
            currentCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
            
            crewState.forEach(slot => {
                if (slot.char) {
                    currentCounts[slot.char.rarity]++;
                }
            });

            // Aggiorna HTML
            for (let r = 5; r >= 1; r--) {
                const el = document.getElementById(`limit-${r}`);
                const countSpan = document.getElementById(`count-${r}`);
                const maxSpan = document.getElementById(`max-${r}`);
                const max = RARITY_LIMITS[r];
                
                // Se siamo in Sandbox, mostriamo infinito
                if (isSandboxMode) {
                    countSpan.innerText = "‚àû"; 
                    if(maxSpan) maxSpan.style.display = 'none'; // Nascondi il "/1"
                    el.classList.remove('limit-full', 'limit-ok', 'limit-over');
                    el.classList.add('limit-ok'); // Tutto verde
                } else {
                    // Modalit√† Normale
                    countSpan.innerText = currentCounts[r];
                    if(maxSpan) {
                        maxSpan.style.display = 'inline';
                        maxSpan.innerText = "/" + (max > 900 ? "‚àû" : max);
                    }

                    // Reset classi
                    el.classList.remove('limit-full', 'limit-ok', 'limit-over');

                    if (max < 900) {
                        if (currentCounts[r] > max) {
                            el.classList.add('limit-over'); // Rosso se superato (succede se cambi da sandbox a standard)
                        } else if (currentCounts[r] === max) {
                            el.classList.add('limit-full'); // Grigio barrato se pieno
                        } else if (currentCounts[r] > 0) {
                            el.classList.add('limit-ok'); // Oro se ne hai qualcuno
                        }
                    }
                }
            }
            
            // Ricarica la lista per disabilitare/abilitare i personaggi
            filterCharacters(); 
        }

        function renderOptionsBar() {
            const container = document.getElementById('options-container');
            const customDiv = document.querySelector('.custom-role-container');
            const existingBtns = container.querySelectorAll('.generated-btn');
            existingBtns.forEach(btn => btn.remove());

            availableOptionalRoles.forEach(role => {
                const btn = document.createElement('button');
                btn.className = 'option-btn generated-btn';
                btn.innerText = "+ " + role;
                const isAlreadyInCrew = crewState.some(slot => slot.role === role);
                if (isAlreadyInCrew) {
                    btn.disabled = true;
                } else {
                    btn.onclick = () => addOptionalRole(role);
                }
                container.insertBefore(btn, customDiv);
            });
        }

        function renderCrew() {
            const container = document.getElementById('crew-container');
            container.innerHTML = '';

            crewState.forEach(slot => {
                const card = document.createElement('div');
                card.className = 'role-card';
                if (selectedSlotId === slot.id) card.classList.add('active');
                card.onclick = () => selectSlot(slot.id);

                let imageHtml = `<span style="font-size: 2rem; color: #8b7d6b;">?</span>`;
                let nameHtml = "WANTED";
                let nameColor = "#666";
                let starsHtml = "";

                if (slot.char) {
                    imageHtml = `<img src="${slot.char.img}">`;
                    nameHtml = slot.char.name;
                    nameColor = "#8b0000";
                    starsHtml = "‚≠ê".repeat(slot.char.rarity);
                }

                card.innerHTML = `
                    <button class="remove-btn" onclick="handleRemove(event, ${slot.id})">X</button>
                    <div class="role-name">${slot.role}</div>
                    <div class="image-slot" style="${slot.char ? 'border-color: var(--rarity-' + slot.char.rarity + ')' : ''}">${imageHtml}</div>
                    <div class="card-stars" style="color: var(--rarity-${slot.char ? slot.char.rarity : '1'})">${starsHtml}</div>
                    <div class="bounty-text" style="color: ${nameColor}; font-weight: ${slot.char ? 'bold' : 'normal'}">${nameHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function addOptionalRole(roleName) {
            const newId = Date.now();
            crewState.push({ id: newId, role: roleName, char: null, isMandatory: false });
            renderOptionsBar();
            renderCrew();
        }

        function addCustomRole() {
            const input = document.getElementById('customRoleInput');
            const roleName = input.value.trim();
            if (!roleName) return alert("The name!");
            const newId = Date.now();
            crewState.push({ id: newId, role: roleName, char: null, isMandatory: false });
            input.value = "";
            renderCrew();
        }

        function handleRemove(event, id) {
            event.stopPropagation();
            const slotIndex = crewState.findIndex(s => s.id === id);
            if (slotIndex === -1) return;

            const slot = crewState[slotIndex];
            
            if (slot.isMandatory) {
                slot.char = null;
            } else {
                crewState.splice(slotIndex, 1);
                if (selectedSlotId === id) selectedSlotId = null;
            }

            renderOptionsBar();
            updateLimitsUI(); // Ricalcola i limiti
            renderCrew();
        }

        function selectSlot(id) {
            selectedSlotId = id;
            renderCrew();
            document.querySelector('.tavern-section').scrollIntoView({ behavior: 'smooth' });
        }

        function assignCharacter(char) {
            if (selectedSlotId === null) {
                alert("Choose the role before!");
                return;
            }

            // CONTROLLO LIMITI (Solo se NON siamo in Sandbox)
            if (!isSandboxMode) {
                const currentCount = currentCounts[char.rarity];
                const maxLimit = RARITY_LIMITS[char.rarity];
                
                if (currentCount >= maxLimit) {
                    alert(`Limite raggiunto per questa rarit√† (${maxLimit})! Rimuovi qualcuno prima.`);
                    return;
                }
            }

            const slot = crewState.find(s => s.id === selectedSlotId);
            if (slot) {
                slot.char = char;
                selectedSlotId = null;
                updateLimitsUI(); // Aggiorna i contatori
                renderCrew();
                document.querySelector('.crew-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderCharacterList(list) {
            const grid = document.getElementById('char-grid');
            grid.innerHTML = '';
            
            list.forEach(char => {
                const item = document.createElement('div');
                item.className = `char-select rarity-${char.rarity}`;
                
                // Controlla se disabilitato (Solo se NON siamo in Sandbox)
                let isFull = false;
                if (!isSandboxMode) {
                    isFull = currentCounts[char.rarity] >= RARITY_LIMITS[char.rarity];
                }

                if (isFull) {
                    item.classList.add('disabled');
                    item.onclick = () => alert("You reach the limit. You can try the sandbox modality");
                } else {
                    item.onclick = () => assignCharacter(char);
                }

                const stars = "‚≠ê".repeat(char.rarity);
                item.innerHTML = `
                    <img src="${char.img}" loading="lazy">
                    <span class="char-stars">${stars}</span>
                    <span class="char-name">${char.name}</span>
                `;
                grid.appendChild(item);
            });
        }

        function filterCharacters() {
            const query = document.getElementById('search').value.toLowerCase();
            const filtered = characters.filter(c => c.name.toLowerCase().includes(query));
            renderCharacterList(filtered);
        }

        // --- FUNZIONE SALVATAGGIO IMMAGINE ---
        function downloadCrew() {
            const crewElement = document.getElementById('crew-container');
            const btn = document.querySelector('.save-btn');
            
            const removeBtns = document.querySelectorAll('.remove-btn');
            const activeCards = document.querySelectorAll('.role-card.active');
            
            removeBtns.forEach(b => b.style.display = 'none');
            activeCards.forEach(c => c.classList.remove('active')); 
            
            const originalText = btn.innerText;
            btn.innerText = "üì∏ Scatto in corso...";

            html2canvas(crewElement, {
                backgroundColor: null, 
                scale: 2, 
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'la-mia-ciurma-one-piece.png';
                link.href = canvas.toDataURL("image/png");
                link.click();

                btn.innerText = originalText;
                
                renderCrew(); 
                if(selectedSlotId) selectSlot(selectedSlotId); 
            }).catch(err => {
                console.error("Errore salvataggio:", err);
                alert("Impossibile salvare l'immagine.");
                btn.innerText = originalText;
                renderCrew();
            });
        }

        init();

    </script>
</body>
</html>
